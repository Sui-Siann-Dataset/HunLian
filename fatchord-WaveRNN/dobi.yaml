#
# Build a minimal docker image for a static go binary.
# See README.md for a full description.
#

meta:
  project: SuiSiann-WaveRNN

mount=giliau_huetshut:
  bind: ./giliau/
  path: /giliau/

mount=giliau:
  bind: ./giliau/
  path: /giliau/
  read-only: true

mount=tshamsoo:
  bind: ./tshamsoo/
  path: /tshamsoo/
  read-only: true

mount=data:
  bind: ./data/
  path: /data/

mount=outputs:
  bind: ./model_outputs/
  path: /WaveRNN/model_outputs/

mount=checkpoints:
  bind: ./checkpoints/
  path: /WaveRNN/checkpoints/

image=hapsing-giliau:
  image: i3thuan5/hapsing-giliau
  context: hapsing-giliau

job=huetshut-suisiann-giliau:
  use: hapsing-giliau
  sources: ./hapsing-giliau/Dockerfile
  artifact: ./giliau/
  mounts: [giliau_huetshut, ]

image=hunlian-khuanking:
  image: hunlian-khuanking
  context: hunlian-khuanking

job=preprocess:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      cp /tshamsoo/hparams.py .
      cp /tshamsoo/preprocess.py .
      cp /tshamsoo/text_init.py utils/text/__init__.py
      cp /tshamsoo/symbols.py utils/text/symbols.py
      python preprocess.py --path /giliau/
    '
  mounts: [giliau_huetshut, tshamsoo, data, ]

job=tacotron:
  use: hunlian-khuanking
  env:
  - CUDA_VISIBLE_DEVICES=0
  command: |
    bash -eux -c '
      cp /tshamsoo/hparams.py .
      cp /tshamsoo/text_init.py utils/text/__init__.py
      cp /tshamsoo/symbols.py utils/text/symbols.py
      python train_tacotron.py
    '
  mounts: [tshamsoo, data, checkpoints, ]

job=tacotron-gta:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      cp /tshamsoo/hparams.py .
      cp /tshamsoo/text_init.py utils/text/__init__.py
      cp /tshamsoo/symbols.py utils/text/symbols.py
      python train_tacotron.py --force_gta
    '
  mounts: [tshamsoo, data, checkpoints, ]

job=wavernn:
  use: hunlian-khuanking
  env:
  - CUDA_VISIBLE_DEVICES=0
  command: |
    bash -eux -c '
      cp /tshamsoo/hparams.py .
      cp /tshamsoo/text_init.py utils/text/__init__.py
      cp /tshamsoo/symbols.py utils/text/symbols.py
      python train_wavernn.py --gta
    '
  mounts: [tshamsoo, data, checkpoints, ]


job=huatsiann:
  use: hunlian-khuanking
  env:
  - CUDA_VISIBLE_DEVICES=1
  command: |
    bash -eux -c '
      cp /tshamsoo/hparams.py .
      cp /tshamsoo/text_init.py utils/text/__init__.py
      cp /tshamsoo/symbols.py utils/text/symbols.py
      sed -i "s/required=True, //g" gen_tacotron.py
      python gen_tacotron.py --input_text "tak8-ke1 tso3-hue2 lai5 tshit-tho5!" griffinlim
      python gen_tacotron.py --input_text "tak8-ke1 tso3-hue2 lai5 tshit-tho5!" wavernn
    '
  mounts: [tshamsoo, checkpoints, outputs]

job=quick:
  use: hunlian-khuanking
  env:
  - CUDA_VISIBLE_DEVICES=1
  command: |
    bash -eux -c '
      sed -i "s/required=True, //g" gen_tacotron.py
      python quick_start.py -u --input_text "What will happen if I run this command?"
      mv quick_start model_outputs
    '
  mounts: [tshamsoo, checkpoints, outputs]

